<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AlohaMini Dashboard</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; margin: 0; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .camera-grid { display: flex; flex-wrap: wrap; gap: 10px; flex: 2; }
        .camera-box { background: #333; padding: 5px; border-radius: 5px; }
        .camera-box img { max-width: 100%; height: auto; display: block; }
        .camera-title { text-align: center; font-size: 0.9em; margin-bottom: 5px; }
        .status-panel { flex: 1; background: #333; padding: 15px; border-radius: 5px; min-width: 300px; }
        .controls-panel { width: 100%; background: #333; padding: 15px; border-radius: 5px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 5px; border-bottom: 1px solid #444; font-size: 0.9em; }
        th { text-align: left; color: #aaa; }
        .value { font-family: monospace; color: #4f4; }
        .btn { padding: 10px 20px; font-size: 16px; margin-right: 10px; cursor: pointer; background: #555; color: white; border: none; border-radius: 4px; }
        .btn:hover { background: #777; }
        .btn-record { background: #c00; }
        .btn-record:hover { background: #e00; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-active { background: #0f0; }
        .status-inactive { background: #555; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>AlohaMini Dashboard</h1>
        <div>
            <span id="connectionStatus" class="status-indicator status-inactive"></span> <span id="connectionText">Disconnected</span>
        </div>
    </div>
    
    <div class="container">
        <div class="camera-grid" id="cameraGrid">
            <!-- Cameras will be injected here -->
        </div>
        
        <div class="status-panel">
            <h3>Robot State</h3>
            <table id="statusTable">
                <!-- Status rows injected here -->
            </table>
        </div>
    </div>

    <div class="controls-panel">
        <h3>Simulation Controls</h3>
        <p>Control the remote simulation directly from here.</p>
        <button class="btn" onclick="sendCommand('reset_sim')">Reset Simulation</button>
        <button class="btn btn-record" id="recordBtn" onclick="toggleRecording()">Start Recording</button>
        <span id="recordingStatus" style="margin-left: 10px; color: #aaa;"></span>
    </div>

    <script>
        const knownCameras = ['head_top', 'head_back', 'head_front', 'wrist_left', 'wrist_right', 'cam_high', 'cam_low', 'cam_left_wrist', 'cam_right_wrist'];
        const activeCameras = new Set();

        let isRecording = false;

        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordingStatus');
            
            if (isRecording) {
                btn.textContent = "Stop Recording";
                btn.style.background = "#555";
                status.textContent = "Recording in progress...";
                sendCommand('start_recording');
            } else {
                btn.textContent = "Start Recording";
                btn.style.background = "#c00";
                status.textContent = "Saved.";
                sendCommand('stop_recording');
                setTimeout(() => status.textContent = "", 3000);
            }
        }

        function sendCommand(cmd) {
            console.log("Sending command:", cmd);
            fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: cmd })
            });
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update connection indicator
                    const connInd = document.getElementById('connectionStatus');
                    const connText = document.getElementById('connectionText');
                    if (data.connected) {
                        connInd.className = 'status-indicator status-active';
                        connText.textContent = "Connected";
                    } else {
                        connInd.className = 'status-indicator status-inactive';
                        connText.textContent = "Disconnected";
                    }

                    const table = document.getElementById('statusTable');
                    let rows = '';
                    
                    // Update Status Table
                    for (const [key, value] of Object.entries(data)) {
                        
                        // Check if this key is a camera placeholder
                        if (value === "__IMAGE_DATA__") {
                           if (!activeCameras.has(key) && !document.getElementById('cam-' + key)) {
                               addCamera(key);
                               activeCameras.add(key);
                           }
                           continue; // Don't show camera keys in text table
                        }
                        
                        // Skip if it looks like a camera key but we didn't get image data marker
                        // (This avoids treating wrist_roll.pos as a camera)
                        if (knownCameras.includes(key)) {
                             // It's a known camera but value isn't image data? 
                             // Maybe it's empty string or something.
                             // Let's just continue to show it as text if it's not __IMAGE_DATA__
                        }

                        let displayValue = value;
                        if (typeof value === 'number') {
                            displayValue = value.toFixed(2);
                        } else if (typeof value === 'object') {
                            displayValue = JSON.stringify(value, null, 2);
                        }
                        
                        rows += `<tr><th>${key}</th><td class="value" style="white-space: pre;">${displayValue}</td></tr>`;
                    }
                    table.innerHTML = rows;
                })
                .catch(err => console.error("Error fetching status:", err));
        }

        function addCamera(name) {
            const grid = document.getElementById('cameraGrid');
            const div = document.createElement('div');
            div.className = 'camera-box';
            div.id = 'cam-' + name;
            div.innerHTML = `
                <div class="camera-title">${name}</div>
                <img src="/video_feed/${name}" alt="${name}" width="320" height="240">
            `;
            grid.appendChild(div);
        }

        setInterval(updateStatus, 1000);
        updateStatus();
    </script>
</body>
</html>
